(()=>{function m(n,e){let s=!1,t,a;function c(){if(s){t=arguments,a=this;return}n.apply(this,arguments),s=!0,setTimeout(function(){s=!1,t&&(c.apply(a,t),t=a=null)},e)}return c}var l=class{cacheName;commitsUrl;urls;lazyCheckUpdates;constructor(e,s){this.cacheName=e,this.commitsUrl=s,this.urls=new Set,this.lazyCheckUpdates=m(this.checkUpdates,60*60*1e3)}async get(e,s=!1){try{let t=await fetch(e,{cache:s?"no-cache":"default"});return s||await(await caches.open(this.cacheName)).put(e,t.clone()),t}catch(t){console.warn("[SW]: No internet connection")}}async updateCache(e,s=!0){console.log("[SW]: Update cache"),s?(await caches.keys()).forEach(a=>{caches.delete(a).then()}):(await(await caches.open(this.cacheName)).put(this.commitsUrl,e),[...this.urls.values()].forEach(a=>{this.get(a)}))}async checkUpdates(e=!1){console.log("[SW]: Check updates...");let s=await this.get(this.commitsUrl,!0);if(!s)return;let t=s.clone(),c=await(await caches.open(this.cacheName)).match(this.commitsUrl);if(c||(e=!0),e){this.updateCache(t,!1);return}let o=async r=>{if(!r)return"";let i=await r.clone().json(),h=Array.isArray(i)&&i.length?i[0]:null;return h?h.sha:""},d=await o(s),p=await o(c);d!==p?(this.updateCache(t),this.newVersionIsAvailable()):console.log("[SW]: No updates found")}async newVersionIsAvailable(){console.log("[SW]: Please reload the page");let e={message:"[SW]: Update me, please",code:1};self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then(s=>{s.forEach(t=>{t.postMessage(JSON.stringify(e))})})}async onFetch(e){let s=new URL(e.url);if(["https://fonts.gstatic.com","https://fonts.googleapis.com",location.origin].includes(s.origin))return this.urls.add(e.url),this.lazyCheckUpdates(),await(await caches.open(this.cacheName)).match(e)||await this.get(e)}},u=new l("cache-v4","https://api.github.com/repos/Artik-Man/artik.me/commits");self.addEventListener("install",()=>{console.log("[SW]: Install"),self.skipWaiting(),setTimeout(()=>{u.checkUpdates(!0).then()},2e3)});self.addEventListener("fetch",async n=>{try{n.respondWith(u.onFetch(n.request))}catch(e){}});})();
